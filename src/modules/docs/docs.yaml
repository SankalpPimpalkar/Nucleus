openapi: 3.0.0

info:
  title: Nucleus API
  version: 1.0.0
  description: Backend API for Nucleus (Auth, Orgs, Projects, RBAC)

servers:
  - url: http://localhost:3000
    description: Local development
  - url: https://nucleus-sand.vercel.app
    description: Production (Vercel)

tags:
  - name: Auth
  - name: Organizations
  - name: Projects
  - name: Members
  - name: Authorization

paths:
  /api/auth/register:
    post:
      tags: [Auth]
      summary: Register user
      operationId: registerUser
      requestBody:
        $ref: '#/components/requestBodies/Register'
      responses:
        '200':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /api/auth/login:
    post:
      tags: [Auth]
      summary: Login user
      operationId: loginUser
      requestBody:
        $ref: '#/components/requestBodies/Login'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /api/auth:
    delete:
      tags: [Auth]
      summary: Logout user
      operationId: logoutUser
      responses:
        '200':
          description: Logout successful

    get:
      tags: [Auth]
      summary: Get user by email
      operationId: getUserByEmail
      parameters:
        - name: email
          in: query
          required: true
          schema:
            type: string
            format: email
      responses:
        '200':
          description: User fetched
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /api/auth/me:
    get:
      tags: [Auth]
      summary: Get current user
      operationId: getCurrentUser
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /api/orgs:
    post:
      tags: [Organizations]
      summary: Create organization
      operationId: createOrganization
      requestBody:
        $ref: '#/components/requestBodies/CreateOrg'
      responses:
        '200':
          description: Organization created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'

    get:
      tags: [Organizations]
      summary: Get my organizations
      operationId: getMyOrganizations
      responses:
        '200':
          description: Organizations list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Organization'

  /api/orgs/{orgId}:
    get:
      tags: [Organizations]
      summary: Get organization
      parameters:
        - $ref: '#/components/parameters/orgId'
      responses:
        '200':
          description: Organization details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'

    patch:
      tags: [Organizations]
      summary: Update organization name
      parameters:
        - $ref: '#/components/parameters/orgId'
      requestBody:
        $ref: '#/components/requestBodies/UpdateOrgName'
      responses:
        '200':
          description: Organization updated

    delete:
      tags: [Organizations]
      summary: Delete organization
      parameters:
        - $ref: '#/components/parameters/orgId'
      responses:
        '200':
          description: Organization deleted

  /api/orgs/{orgId}/projects:
    post:
      tags: [Projects]
      summary: Create project
      parameters:
        - $ref: '#/components/parameters/orgId'
      requestBody:
        $ref: '#/components/requestBodies/CreateProject'
      responses:
        '200':
          description: Project created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'

    get:
      tags: [Projects]
      summary: Get projects
      parameters:
        - $ref: '#/components/parameters/orgId'
      responses:
        '200':
          description: Projects list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Project'

  /api/orgs/{orgId}/projects/{projectId}:
    get:
      tags: [Projects]
      summary: Get project
      parameters:
        - $ref: '#/components/parameters/orgId'
        - $ref: '#/components/parameters/projectId'
      responses:
        '200':
          description: Project details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'

    delete:
      tags: [Projects]
      summary: Delete project
      parameters:
        - $ref: '#/components/parameters/orgId'
        - $ref: '#/components/parameters/projectId'
      responses:
        '200':
          description: Project deleted

  /api/orgs/{orgId}/projects/{projectId}/members:
    post:
      tags: [Members]
      summary: Add member
      parameters:
        - $ref: '#/components/parameters/orgId'
        - $ref: '#/components/parameters/projectId'
      requestBody:
        $ref: '#/components/requestBodies/AddMember'
      responses:
        '200':
          description: Member added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Member'

    get:
      tags: [Members]
      summary: Get members
      parameters:
        - $ref: '#/components/parameters/orgId'
        - $ref: '#/components/parameters/projectId'
      responses:
        '200':
          description: Members list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Member'

  /api/orgs/{orgId}/projects/{projectId}/roles:
    get:
      tags: [Authorization]
      summary: Get roles
      parameters:
        - $ref: '#/components/parameters/orgId'
        - $ref: '#/components/parameters/projectId'
      responses:
        '200':
          description: Roles list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Role'

    post:
      tags: [Authorization]
      summary: Add role
      parameters:
        - $ref: '#/components/parameters/orgId'
        - $ref: '#/components/parameters/projectId'
      requestBody:
        $ref: '#/components/requestBodies/AddRole'
      responses:
        '200':
          description: Role created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'

components:
  parameters:
    orgId:
      name: orgId
      in: path
      required: true
      schema:
        type: string
        example: 64f1b2c3e4a5b6c7d8e9f001

    projectId:
      name: projectId
      in: path
      required: true
      schema:
        type: string

    memberId:
      name: memberId
      in: path
      required: true
      schema:
        type: string

    roleId:
      name: roleId
      in: path
      required: true
      schema:
        type: string

  schemas:
    User:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        email:
          type: string
          format: email
        email_verified:
          type: boolean
        auth_provider:
          type: string
          enum: [local, google]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Organization:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        owner:
          type: string
        createdAt:
          type: string
          format: date-time

    Project:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        organization:
          type: string
        created_by:
          type: string
        createdAt:
          type: string
          format: date-time

    Role:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        description:
          type: string
        project:
          type: string

    Permission:
      type: object
      properties:
        _id:
          type: string
        key:
          type: string

    Member:
      type: object
      properties:
        _id:
          type: string
        user:
          type: string
        project:
          type: string
        role:
          type: string

  requestBodies:
    Register:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [name, email, password]
            properties:
              name:
                type: string
              email:
                type: string
              password:
                type: string

    Login:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [email, password]
            properties:
              email:
                type: string
              password:
                type: string

    CreateOrg:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [name]
            properties:
              name:
                type: string

    UpdateOrgName:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [name]
            properties:
              name:
                type: string

    CreateProject:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [name]
            properties:
              name:
                type: string

    AddMember:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [userId, roleId]
            properties:
              userId:
                type: string
              roleId:
                type: string

    AddRole:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [name, permissions]
            properties:
              name:
                type: string
              description:
                type: string
              permissions:
                type: array
                items:
                  type: string
